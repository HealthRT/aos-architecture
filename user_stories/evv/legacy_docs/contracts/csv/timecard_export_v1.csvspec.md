# Timecard Export CSV Specification v1

This document defines the structure and content of the CSV export file for Pavillio.

## Export Profiles

The system provides two export profiles for different use cases.

-   **`basic` (Default)**: This is the standard export format for electronic submission to clearinghouses like Pavillio. It contains no Protected Health Information (PHI).
-   **`phi`**: This profile includes additional columns containing PHI for internal reconciliation or auditing purposes. Access to this export is restricted by user role and requires Multi-Factor Authentication (MFA). It is intended for local download only and must be handled according to the `PHI Export Policy` defined in `guardrails.md`.

## Guiding Principles

-   **One Row Per Segment**: Each row in the CSV represents a single, continuous `visit.segment`. A multi-segment visit will appear as multiple rows.
-   **PHI Handling**: The `basic` profile contains no PHI. All identifiers for clients and DSPs are external, non-identifying codes. The `phi` profile contains sensitive data and must be handled with care.

## File Format

-   **Encoding**: UTF-8
-   **Delimiter**: Comma (`,`)
-   **Header**: The file must contain a header row with the exact column names specified below.

## Column Specification (`basic` profile)

| Column Name              | Type      | Required | Description                                                                                             | Example                               |
| :----------------------- | :-------- | :------- | :------------------------------------------------------------------------------------------------------ | :------------------------------------ |
| `external_timecard_id`   | `string`  | Yes      | A unique ID for the entire visit, consistent across all its segments. Generated by our system.            | `VT_20251004_101_302`                 |
| `visit_id`               | `integer` | Yes      | The internal Odoo ID of the `visit` record. Useful for internal traceability.                             | `4521`                                |
| `segment_index`          | `integer` | Yes      | The sequential, 1-based index of the segment within the visit.                                          | `1`                                   |
| `agency_code`            | `string`  | Yes      | The identifier for the provider agency, assigned by the payer.                                          | `AGENCY_123`                          |
| `client_external_id`     | `string`  | Yes      | A non-PHI identifier for the client (e.g., Medicaid ID).                                                | `MCD_987654321`                       |
| `dsp_external_id`        | `string`  | Yes      | A non-PHI identifier for the Direct Support Professional (DSP).                                         | `DSP_5678`                            |
| `service_code`           | `string`  | Yes      | The billing code for the service delivered in this segment.                                             | `S5125`                               |
| `visit_date`             | `date`    | Yes      | The date the visit occurred, in `YYYY-MM-DD` format.                                                      | `2025-10-04`                          |
| `start_time_local`       | `time`    | Yes      | The segment start time in `HH:MM:SS` (24-hour) format, localized to the visit's timezone.               | `09:00:15`                            |
| `end_time_local`         | `time`    | Yes      | The segment end time in `HH:MM:SS` (24-hour) format, localized to the visit's timezone.                 | `10:15:30`                            |
| `duration_minutes_raw`   | `integer` | Yes      | The total duration of the segment in whole minutes, *before* any rounding is applied.                   | `75`                                  |
| `units_billed`           | `decimal` | Yes      | The final number of billable units after rounding and validation.                                       | `5.00`                                |
| `rounding_policy`        | `string`  | Yes      | The rounding rule applied to calculate `units_billed`.                                                  | `nearest_15_min`                      |
| `eligibility_status`     | `string`  | Yes      | `eligible` if the segment is billable, `ineligible` if not.                                             | `eligible`                            |
| `eligibility_reason`     | `string`  | No       | If `ineligible`, the error code explaining why. See `contracts/errors.md`.                              | `EVV_NO_UNITS_AVAILABLE`              |
| `supervisor_approved`    | `boolean` | Yes      | `true` if the visit was approved by a supervisor, `false` otherwise.                                      | `true`                                |
| `notes`                  | `string`  | No       | Any notes attached to the visit, sanitized to remove special characters.                                | `Client was in good spirits.`         |
| `export_batch_id`        | `string`  | Yes      | A unique identifier for the batch export process that generated this file.                              | `EXP_20251005_BATCH_01`               |
| `exported_at_utc`        | `datetime`| Yes      | The UTC timestamp when the export was generated, in ISO 8601 format.                                    | `2025-10-05T14:30:00Z`                |

## Additional Columns (`phi` profile)

The `phi` profile includes all columns from the `basic` profile, plus the following PHI columns.

| Column Name      | Type     | Required | Description                               | Example           |
| :--------------- | :------- | :------- | :---------------------------------------- | :---------------- |
| `client_full_name` | `string` | Yes      | The full legal name of the client.        | `Jane Doe`        |
| `dsp_full_name`  | `string` | Yes      | The full legal name of the DSP.           | `John Smith`      |

## Example: Multi-Segment Visit (`basic` profile)

Here is an example of a single visit with two segments using the `basic` profile.

```csv
external_timecard_id,visit_id,segment_index,agency_code,client_external_id,dsp_external_id,service_code,visit_date,start_time_local,end_time_local,duration_minutes_raw,units_billed,rounding_policy,eligibility_status,eligibility_reason,supervisor_approved,notes,export_batch_id,exported_at_utc
VT_20251004_101_302,4521,1,AGENCY_123,MCD_987654321,DSP_5678,S5125,2025-10-04,09:00:15,10:15:30,75,5.00,nearest_15_min,eligible,,true,"Client was in good spirits.",EXP_20251005_BATCH_01,2025-10-05T14:30:00Z
VT_20251004_101_302,4521,2,AGENCY_123,MCD_987654321,DSP_5678,S5130,2025-10-04,10:15:31,11:05:00,49,3.00,nearest_15_min,eligible,,true,"Client was in good spirits.",EXP_20251005_BATCH_01,2025-10-05T14:30:00Z
```
