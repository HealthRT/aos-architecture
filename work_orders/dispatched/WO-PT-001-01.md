---
title: "[FEATURE] WO-PT-001-01: Implement evv.patient Model"
repo: "HealthRT/evv"
assignee: "aos-coder-agent"
labels: "agent:coder,module:evv-compliance,priority:high"
---
# Work Order: WO-PT-001-01 – Implement evv.patient Model

## 1. Context & Objective

Create the HIPAA-compliant `evv.patient` model, associated views, security, and documentation as defined in `PT-001`, including unique external ID enforcement and partner search disambiguation.

---

## 2. Repository Setup

**Repository:** evv  
**Base Branch:** main  
**New Branch:** feature/WO-PT-001-01-patient-model

**Setup Commands:**
```bash
cd /home/james/development/aos-development/evv
git checkout main
git pull origin main
git checkout -b feature/WO-PT-001-01-patient-model
```

Confirm pre-commit hooks are active per contributor guide.

---

## 3. Problem Statement & Technical Details

### Model Implementation
- File: `evv/addons/evv_patients/models/evv_patient.py`
- Define `evv.patient` with fields:
  - `partner_id` (Many2one `res.partner`, required)
  - `recipient_id_external` (Char, optional, unique when set)
  - `case_manager_id` (Many2one `evv.case_manager`, optional)
  - `name` (Related `partner_id.name`, stored, readonly)
- Add SQL constraint ensuring unique `recipient_id_external` (allow null duplicates).
- Consider setting `_rec_name = 'name'`.
- Implement `name_get` helper if needed for better display (document if using default).

### Partner Search Disambiguation
- Extend or override `res.partner` search name to include non-sensitive fields (e.g., email, city) when selecting patient partner. Options:
  - Override `name_get` in `evv_patients` to add context for patient selection.
  - Or create custom search view domain using `display_name` with additional info.
- Document approach in code and tests.

### Views
- File: `evv/addons/evv_patients/views/evv_patient_views.xml`
- Create tree/form views aligning with mockup, include partner search improvements. Provide menu entry under EVV management accessible to DC/Administrator.
- Include search view with partner information columns.

### Security
- File: `evv/addons/evv_patients/security/ir.model.access.csv`
  - DC role: create/read/write
  - Clinical Supervisor (read only) per compliance? (Spec only mentions DC create/read/write; ensure read for Clinical Supervisor if role exists; document assumption.)
  - Admin: full access
- Add record rules if necessary to restrict to allowed roles.

### Tests
- File: `evv/addons/evv_patients/tests/test_patient_record.py`
- SavepointCase verifying creation, unique external ID constraint, case manager linking, partner search disambiguation (assert search results include extra info), access control enforcement.

### Documentation
- File: `evv/addons/evv_patients/docs/models/evv_patient.md`
- Document model purpose, fields, constraints, partner search behavior, security.

### Manifest
- Update `evv/addons/evv_patients/__manifest__.py` to include new files and dependencies (`evv_case_managers`, `evv_core`).

---

## 4. Required Implementation

### Model & Constraints
- Implement `_sql_constraints` for `recipient_id_external` uniqueness (case-sensitive or insensitive? Document assumption; default case-sensitive acceptable unless spec says otherwise).
- Ensure `case_manager_id` uses domain `[('id','!=', partner_id)]` if necessary; document decision.
- Consider computed helper to propagate `recipient_id_external` to agreements via related field (already spec’d for agreements). Ensure patient stores value.

### Security & ACLs
- Provide ACL entries aligning with compliance: DC create/read/write, Admin full, other roles denied. Include record rules if necessary for supervisors.
- Ensure module install includes groups if needed (use existing role groups).

### Partner Search Enhancement
- Modify `res.partner` `name_get` via extension in `evv_patients` to include additional identifiers for individuals (e.g., email, city). Ensure does not impact company contacts negatively.
- Add tests verifying search output strings in patient selection context.

### Tests
- SavepointCase scenarios:
  - DC user creates patient with partner link.
  - Duplicate `recipient_id_external` raises `ValidationError`.
  - Case manager assignment persists.
  - Search results show disambiguating info when multiple partners share name.
  - Unauthorized user receives `AccessError`.
- Use synthetic data; docstrings reference `PT-001`.

### Views & UX
- Form view shows partner, external ID, case manager; add placeholder One2many for agreements (optional comment indicating future implementation). Keep view minimal yet compliant.

### Documentation
- Cover fields, constraints, security, search enhancement, relationships.

---

## 5. Acceptance Criteria

- [ ] `evv.patient` model implemented with fields, unique constraint, and related name.
- [ ] Partner search provides disambiguating info for same-name contacts.
- [ ] Views allow DC/Admin to manage patients; UI aligns with mockup.
- [ ] ACLs enforce role-based access per compliance section.
- [ ] SavepointCase tests cover creation, duplicate prevention, access control, search behavior (0 failures).
- [ ] Documentation added/updated for patient model.
- [ ] Code references Story `PT-001` as appropriate.
- [ ] Odoo boots without errors (MANDATORY).
- [ ] Proof of execution logs captured (tests + boot + upgrade).

---

## 6. Context Management & Iteration Limits

Adhere to standard workflow; escalate if search customization conflicts with global partner naming strategy.

---

## 7. Required Context Documents

- `@aos-architecture/specs/evv/PT-001.yaml`
- `@aos-architecture/specs/evv/CM-001.yaml`
- `@aos-architecture/specs/core/CORE-001.yaml`
- `@aos-architecture/standards/01-odoo-coding-standards.md`
- `@aos-architecture/standards/08-testing-requirements.md`
- `@aos-architecture/standards/TESTING_STRATEGY.md`
- `@aos-architecture/decisions/003-internal-api-first-design.md`
- `@aos-architecture/decisions/006-multi-tenancy-strategy.md`

---

## 7. Technical Constraints

- Maintain HIPAA compliance; avoid leaking PHI via partner search (limit to non-sensitive fields e.g., email, city).
- Ensure bootability: manifest updates, security present.
- Keep change size manageable (<500 LOC).

---

## 8. MANDATORY: Proof of Execution

### 8.1 Test Execution
```bash
cd /home/james/development/aos-development
docker compose exec evv odoo-bin \
  -c /etc/odoo/odoo.conf \
  -d evv \
  --test-enable \
  --stop-after-init \
  -i evv_patients \
  --log-level=test:INFO
```
- Attach full test output (counts, duration, 0 failures).

### 8.2 Boot Verification
```bash
docker compose up -d --force-recreate evv
sleep 30
docker compose logs --tail="100" evv
```
- Provide last 100 log lines showing successful boot.

### 8.3 Module Upgrade Test
```bash
docker compose exec evv odoo-bin \
  -c /etc/odoo/odoo.conf \
  -d evv \
  -u evv_patients \
  --stop-after-init
```
- Summarize upgrade output confirming no errors.

If Docker unavailable, escalate immediately.


