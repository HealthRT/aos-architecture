---
title: "[FIX] PT-001-FIX-01: Fix Critical Security and Functional Failures in evv_patients"
repo: "HealthRT/evv"
assignee: "aos-coder-agent"
labels: "agent:coder,type:fix,module:evv-compliance,priority:critical"
---
# Work Order: PT-001-FIX-01 - Fix Critical Security and Functional Failures in evv_patients

## 1. Context & Objective

**REMEDIATION WORK ORDER** - Fix critical failures in PT-001-CODE-01 that prevent the `evv_patients` module from being installable and violate functional requirements.

**Original Work Order:** PT-001-CODE-01
**Failed Branch:** `feature/PT-001-CODE-01-patient-model`
**Failure Type:** Critical security flaw + functional requirement violation
**Architect Verdict:** REJECTED - Module not installable, false success report

---

## 2. Development Environment (CRITICAL - Read First)

**Per ADR-013 (Repository Boundaries) - MUST VERIFY BEFORE STARTING**

### Target Repository
**Repository:** evv
**GitHub URL:** github.com/HealthRT/evv
**Target Module:** `evv_patients`
**Module Prefix:** `evv_*`

### Pre-Work Verification Checklist

**BEFORE starting any work, you MUST complete these steps:**

```bash
# Step 1: Navigate to target repository
cd /home/james/development/aos-development/evv/

# Step 2: Verify correct repository (MANDATORY)
git remote -v
# Expected output: origin  https://github.com/HealthRT/evv.git

# Step 3: Verify Docker environment exists
ls docker-compose.yml
# Must exist in repository root

# Step 4: Verify module prefix matches repository
# For EVV: module must be evv_*
```

- [ ] Confirmed `git remote -v` shows correct repository (HealthRT/evv)
- [ ] Confirmed `docker-compose.yml` exists in repository root
- [ ] Confirmed module prefix matches repository per ADR-013
- [ ] Read repository's `README.md` file

### Docker Environment

For automated testing, the `run-tests.sh` script handles its own environment creation and cleanup.

### **CRITICAL: IMMUTABLE TOOLING**

The script located at `scripts/run-tests.sh` is a piece of core testing infrastructure.

-   **You are NOT authorized to modify this script.**
-   Your task is to EXECUTE this script as-is.
-   If the script fails, your objective is to analyze the logs, document the failure in your report, and escalate.
-   **DO NOT attempt to "fix" the tooling.** An error in the script is an infrastructure bug that must be escalated to the Executive Architect.

**Database:** postgres

### Git Workflow

**Base Branch:** `main`
**New Branch:** `feature/PT-001-FIX-01-security-and-name-get`

**Branch Naming Convention (ADR-014):**
```
feature/{STORY_ID}-{TYPE}-{SEQUENCE}-{short-description}
```

**Setup Commands:**
```bash
# After verifying you're in the correct repository
cd /home/james/development/aos-development/evv/
git checkout main
git pull origin main
git checkout -b feature/PT-001-FIX-01-security-and-name-get
```

**Note:** The failed branch `feature/PT-001-CODE-01-patient-model` contains the broken implementation. You will be fixing the issues on a NEW branch starting from `main`.

---

## 3. Problem Statement & Technical Details

### Critical Failure #1: Missing Security Groups Definition

**File:** `evv/addons/evv_patients/security/ir.model.access.csv`
**Issue:** References two security groups that are never created:
- `group_evv_patients_admin`
- `group_evv_patients_dc`

**Current State (BROKEN):**
The ACL file references these groups, but there is **NO** corresponding `security/groups.xml` file that creates them. This will cause Odoo to crash on module installation with:
```
ValueError: External ID not found in system: evv_patients.group_evv_patients_admin
```

**Impact:** Module is not installable. System crash on install attempt.

---

### Critical Failure #2: Incorrect `name_get` Override Implementation

**File:** `evv/addons/evv_patients/models/res_partner.py` (presumed location)
**Issue:** The `name_get` override was implemented incorrectly:

**What was required (from PT-001.yaml):**
> "Override partner.name_get to disambiguate (e.g., "John Doe (Patient, MRN: 12345)")."

**What was implemented (WRONG):**
A generic override that adds email/city to ALL partner lookups system-wide:
```python
def name_get(self):
    result = []
    for partner in self:
        name = partner.name or ''
        if partner.email:
            name = f"{name} ({partner.email})"
        elif partner.city:
            name = f"{name} ({partner.city})"
        result.append((partner.id, name))
    return result
```

**Problems:**
1. **Wrong Scope:** Applies to ALL partners, not just patients
2. **Wrong Logic:** Shows email/city instead of "Patient, MRN: XXX"
3. **Wrong Condition:** Should only trigger for partners linked to `evv.patient` records

**Impact:** Functional requirement not met. Disambiguation does not work as specified.

---

## 4. Required Implementation

### Fix #1: Create Missing Security Groups

**Create new file:** `evv/addons/evv_patients/security/groups.xml`

**Required Content:**
```xml
<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <!-- Patient Direct Care Worker Group -->
        <record id="group_evv_patients_dc" model="res.groups">
            <field name="name">Patient Direct Care</field>
            <field name="category_id" ref="base.module_category_human_resources"/>
            <field name="comment">Access to view and create patient records</field>
        </record>

        <!-- Patient Administrator Group -->
        <record id="group_evv_patients_admin" model="res.groups">
            <field name="name">Patient Administrator</field>
            <field name="category_id" ref="base.module_category_human_resources"/>
            <field name="implied_ids" eval="[(4, ref('group_evv_patients_dc'))]"/>
            <field name="comment">Full access to patient records including deletion</field>
        </record>
    </data>
</odoo>
```

**Update:** `evv/addons/evv_patients/__manifest__.py`

Add the groups file to the data section BEFORE the ACL file:
```python
'data': [
    'security/groups.xml',  # MUST come before ir.model.access.csv
    'security/ir.model.access.csv',
    'views/evv_patient_views.xml',
],
```

---

### Fix #2: Correct `name_get` Override Logic

**File:** `evv/addons/evv_patients/models/res_partner.py`

**Replace the entire `name_get` method with:**

```python
def name_get(self):
    """
    Override to disambiguate partners linked to EVV patients.
    Display format: "Partner Name (Patient, MRN: 12345)"
    Only applies to partners that have an associated evv.patient record.
    """
    result = []
    for partner in self:
        name = partner.name or ''
        
        # Check if this partner is linked to a patient record
        patient = self.env['evv.patient'].search([('partner_id', '=', partner.id)], limit=1)
        
        if patient:
            # Disambiguate with patient context
            name = f"{name} (Patient, MRN: {patient.mrn})"
        
        result.append((partner.id, name))
    return result
```

**Key Requirements:**
1. **Scoped correctly:** Only affects partners linked to `evv.patient` records
2. **Correct format:** "Partner Name (Patient, MRN: XXX)"
3. **Performance:** Uses `limit=1` to avoid loading multiple records
4. **Non-invasive:** Partners without patient records display normally

---

## 5. Acceptance Criteria

⚠️ **CRITICAL WARNING - READ THIS FIRST** ⚠️

**Testing is NEVER optional for ANY work order involving code changes.**

---

### Functional Requirements

**Security Groups:**
- [ ] `security/groups.xml` file created with both groups defined
- [ ] `__manifest__.py` updated to load `groups.xml` BEFORE `ir.model.access.csv`
- [ ] Module installs without errors (no "External ID not found" errors)
- [ ] Both groups visible in Settings > Users & Companies > Groups

**name_get Override:**
- [ ] `name_get` method updated with correct logic
- [ ] Method only affects partners linked to `evv.patient` records
- [ ] Display format matches specification: "Name (Patient, MRN: XXX)"
- [ ] Partners without patient records display normally (unchanged behavior)

### Testing Requirements (MANDATORY)

**Unit Tests:**

Create/update: `evv/addons/evv_patients/tests/test_patient_security.py`
```python
@tagged("post_install", "-at_install", "evv_patients", "security")
class TestPatientSecurity(TransactionCase):
    """Test security groups and access rights"""
    
    def test_security_groups_exist(self):
        """Test: Both security groups are created on install"""
        dc_group = self.env.ref('evv_patients.group_evv_patients_dc', raise_if_not_found=False)
        admin_group = self.env.ref('evv_patients.group_evv_patients_admin', raise_if_not_found=False)
        
        self.assertIsNotNone(dc_group, "DC group not found")
        self.assertIsNotNone(admin_group, "Admin group not found")
        
    def test_admin_implies_dc(self):
        """Test: Admin group implies DC group"""
        admin_group = self.env.ref('evv_patients.group_evv_patients_admin')
        dc_group = self.env.ref('evv_patients.group_evv_patients_dc')
        
        self.assertIn(dc_group, admin_group.implied_ids)
```

Create/update: `evv/addons/evv_patients/tests/test_partner_name_get.py`
```python
@tagged("post_install", "-at_install", "evv_patients", "name_get")
class TestPartnerNameGet(TransactionCase):
    """Test partner name_get disambiguation for patients"""
    
    def test_partner_with_patient_shows_mrn(self):
        """Test: Partner linked to patient displays with MRN"""
        partner = self.env['res.partner'].create({'name': 'John Doe'})
        patient = self.env['evv.patient'].create({
            'partner_id': partner.id,
            'mrn': '12345',
        })
        
        result = partner.name_get()
        self.assertEqual(result[0][1], "John Doe (Patient, MRN: 12345)")
    
    def test_partner_without_patient_unchanged(self):
        """Test: Regular partners display normally"""
        partner = self.env['res.partner'].create({'name': 'Jane Smith'})
        
        result = partner.name_get()
        self.assertEqual(result[0][1], "Jane Smith")
```

- [ ] All security tests pass (`0 failed, 0 error(s)`)
- [ ] All name_get tests pass (`0 failed, 0 error(s)`)
- [ ] ALL existing evv_patients tests still pass (no regressions)

**Installation Test:**
- [ ] Module uninstall/reinstall completes without errors
- [ ] Both security groups persist after reinstall

**Coverage:**
- [ ] Code coverage ≥ 80%
- [ ] Both critical failures are covered by tests

**Proof of Execution:**
- [ ] Test output committed showing ALL tests pass
- [ ] Code committed with descriptive message
- [ ] Proof of execution provided (see Section 9)

---

## 6. Context Management & Iteration Limits

**IMPORTANT:** AI agents have finite context windows. This section prevents context exhaustion.

### Workflow Phases & Checkpoints

**Phase 1: Implementation**
- Create `security/groups.xml` file.
- Update `__manifest__.py` to load groups file.
- Fix `name_get` override in `res_partner.py`.
- **Checkpoint:** Commit working code. `git commit -m "fix(evv_patients): add missing security groups and correct name_get override"`

**Phase 2: Testing**
- Write comprehensive tests as specified above.
- Run tests: `bash scripts/run-tests.sh evv_patients`
- **Checkpoint:** Commit tests. `git commit -m "test(evv_patients): add security and name_get validation tests"`

**Phase 3: Bug Fixing - MAXIMUM 2 ITERATIONS**

**Iteration 1:**
- Analyze test failures, implement a fix, and run tests again.
- If tests pass, proceed to Proof of Execution.
- If tests still fail, commit your attempt and proceed to Iteration 2.

**Iteration 2:**
- Try a **different approach** to fix the issue. Run tests.
- If tests pass, proceed to Proof of Execution.
- If tests still fail, **STOP and ESCALATE.**

### Escalation Process (After 2 Failed Iterations)

**DO NOT** continue debugging. Instead, document your attempts on the GitHub Issue, apply the `status:needs-help` label, and tag `@james-healthrt`.

---

## 7. Required Context Documents

- `@aos-architecture/standards/08-testing-requirements.md` (MANDATORY)
- `@aos-architecture/specs/evv/PT-001.yaml` (Original specification)
- `@evv/qa_reports/CORE-001-QA-01-validation-report.md` (Reference for successful test execution pattern)

---

## 8. Technical Constraints

- **Odoo Version:** All code and XML must be compatible with **Odoo 18.0 Community Edition**.
- **Prohibited Features:** Do not use deprecated fields/APIs or any features exclusive to Odoo Enterprise.
- **Existing Code:** Preserve all other functionality in the `evv_patients` module. Only fix the two identified failures.

---

## 9. MANDATORY: Proof of Execution

**YOU MUST COMPLETE THIS AND POST IT TO THE GITHUB ISSUE BEFORE MARKING AS COMPLETE.**

### 9.1 Test Execution (REQUIRED)

```bash
# From within the evv repository directory
cd /home/james/development/aos-development/evv/
bash scripts/run-tests.sh evv_patients
```

**Expected Output:**
```text
Database container is healthy.
Running tests for module 'evv_patients'...
odoo.tests.stats: evv_patients: [N] tests [X.XX]s [XX] queries
odoo.tests.result: 0 failed, 0 error(s)
Tests passed successfully.
```

**CRITICAL VERIFICATION CHECKLIST:**
- [ ] Tests executed successfully
- [ ] Verify `proof_of_execution_tests.log` created
- [ ] **VERIFY CLEANUP:** Run `docker ps -a | grep evv-agent-test` → Must be empty
- [ ] ALL tests pass (0 failed, 0 error(s))

### 9.2 Security Groups Verification

```bash
# Verify groups are loadable without error
grep "group_evv_patients" evv/addons/evv_patients/security/groups.xml
grep "group_evv_patients" evv/addons/evv_patients/__manifest__.py
```

**Expected:** Both commands return results showing groups are defined and loaded.

### 9.3 Git Proof

```bash
git log --oneline -3
git diff main --stat
```

**Expected:** Shows commits for fix and tests.

---

## 10. GitHub Issue Posting

**After successful completion, post to the GitHub issue:**

```markdown
## PT-001-FIX-01 COMPLETE ✅

**Branch:** `feature/PT-001-FIX-01-security-and-name-get`

### Critical Failures Fixed

**1. Security Groups Created:**
- ✅ `security/groups.xml` added with both groups
- ✅ `__manifest__.py` updated to load groups before ACLs
- ✅ Module now installs without errors

**2. name_get Override Corrected:**
- ✅ Method now scoped to patient-linked partners only
- ✅ Display format: "Name (Patient, MRN: XXX)"
- ✅ Non-patient partners display normally

### Test Results
\```
odoo.tests.stats: evv_patients: [N] tests [X.XX]s [XX] queries
0 failed, 0 error(s) of [N] tests
\```

### Verification
- [X] Security groups visible in Odoo UI
- [X] Patient partners display with MRN
- [X] Non-patient partners unchanged
- [X] All tests pass
- [X] Docker cleanup verified

**Ready for architect review.**
```

---

## Dependencies

**Depends On:** None (fixes PT-001-CODE-01 failures)
**Blocks:** PT-001-QA-01, AGMT-001-CODE-01, Wave 3

---

## Notes

**Agent Performance:**
- This is a remediation work order due to failures in PT-001-CODE-01.
- The original agent (Agent A) provided a false success report and did not implement required functionality.
- **Do not repeat these mistakes:**
  1. Security groups MUST be created before ACLs reference them
  2. Functional requirements MUST be implemented as specified
  3. Success reports MUST be accurate

**Success Criteria:**
- Module is installable
- Both critical failures are fixed
- All tests pass
- No false reports

