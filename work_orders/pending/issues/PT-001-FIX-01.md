---
title: "[FIX] PT-001-FIX-01: Fix Critical Security and Functional Failures in evv_patients"
assignee: "aos-coder-agent"
labels: "agent:coder,type:fix,module:evv-compliance,priority:critical"
---

# Work Order: PT-001-FIX-01 - Fix Critical Security and Functional Failures in evv_patients

**REMEDIATION WORK ORDER** - Fix critical failures in PT-001-CODE-01 that prevent the `evv_patients` module from being installable.

---

## Context

PT-001-CODE-01 was **ARCHITECT REJECTED** due to:
1. **Critical Security Failure:** Missing `security/groups.xml` - ACLs reference non-existent groups
2. **Functional Failure:** `name_get` override implemented incorrectly (wrong scope, wrong logic)
3. **False Success Report:** Agent claimed 6/6 tests passing when module is not installable

**Failed Branch:** `feature/PT-001-CODE-01-patient-model`

---

## Critical Failures to Fix

### Failure #1: Missing Security Groups
- `ir.model.access.csv` references `group_evv_patients_admin` and `group_evv_patients_dc`
- No `security/groups.xml` file exists to create these groups
- Result: Module crashes Odoo on install attempt

**Required Fix:**
- Create `security/groups.xml` with both security groups
- Update `__manifest__.py` to load groups BEFORE ACLs

### Failure #2: Incorrect name_get Override
- **Requirement:** "Override partner.name_get to disambiguate (e.g., 'John Doe (Patient, MRN: 12345)')."
- **What was implemented:** Generic override adding email/city to ALL partners (wrong scope, wrong logic)

**Required Fix:**
- Update `name_get` to only affect partners linked to `evv.patient` records
- Display format: "Name (Patient, MRN: XXX)"
- Non-patient partners display normally

---

## Acceptance Criteria

**Security Groups:**
- [ ] `security/groups.xml` file created with both groups defined
- [ ] `__manifest__.py` updated to load `groups.xml` BEFORE `ir.model.access.csv`
- [ ] Module installs without errors (no "External ID not found" errors)
- [ ] Both groups visible in Settings > Users & Companies > Groups

**name_get Override:**
- [ ] `name_get` method updated with correct logic
- [ ] Method only affects partners linked to `evv.patient` records
- [ ] Display format matches specification: "Name (Patient, MRN: XXX)"
- [ ] Partners without patient records display normally

**Testing:**
- [ ] Security group existence tests written and passing
- [ ] name_get behavior tests written and passing
- [ ] ALL existing evv_patients tests still pass (no regressions)
- [ ] Module install/uninstall cycle completes without errors
- [ ] Test output: `0 failed, 0 error(s)`

**Proof of Execution:**
- [ ] Test logs committed (`proof_of_execution_tests.log`)
- [ ] Docker cleanup verified (no orphaned containers)
- [ ] All code committed with descriptive messages

---

## Test Execution

```bash
cd /home/james/development/aos-development/evv/
bash scripts/run-tests.sh evv_patients
```

**Expected Output:**
```
odoo.tests.stats: evv_patients: [N] tests [X.XX]s [XX] queries
0 failed, 0 error(s) of [N] tests
Tests passed successfully.
```

---

## Dependencies

**Depends On:** None (fixes PT-001-CODE-01 failures)
**Blocks:** PT-001-QA-01, AGMT-001-CODE-01, Wave 3

---

## Critical Notes

⚠️ **ZERO TOLERANCE FOR ERROR** ⚠️

This is a remediation work order. The previous agent:
- Submitted non-installable code
- Claimed success when tests couldn't have run
- Wasted significant time and architect resources

**You MUST:**
1. Implement EXACTLY as specified (code snippets provided in work order)
2. Verify module installation succeeds (install/uninstall cycle)
3. Run ALL tests and confirm 0 failures
4. Report status ACCURATELY (no false success reports)

**Module Installation Verification is MANDATORY:**
- Your implementation must survive an install/uninstall cycle
- If the module doesn't install, the work is NOT complete
- Test this BEFORE claiming completion

---

**Work Order File:** `@aos-architecture/work_orders/pending/PT-001-FIX-01.md`
**Repository:** HealthRT/evv
**Branch:** `feature/PT-001-FIX-01-security-and-name-get`
**Priority:** CRITICAL - Blocks Wave 3

